<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>双系统--WIN7和GENTOO</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="xrfind">
    <meta name="copyright" content="copyright (c) 三月 08, 2011 xrfind">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link type="image/x-icon" rel="shortcut icon" href="../../css/favicon.ico"/>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/moment.min.js"></script>
    <script type="text/javascript" src="../../js/custom.js"> </script> 
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-36694423-1']);
        _gaq.push(['_setDomainName', 'rrrui.com']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script> 
</head>
<body>
    <div id="htop" style="width:128px;height:128px">
    </div>
    <div id="content">
        
<h1 id="toc_1">WIN7&amp;Gentoo双系统</h1>
<h2 id="toc_1.1">情况说明</h2>
<p>
手头上可以用来玩的机器就是一台Thinkpad R400 2784a52，本来是win7，平常用来上上网看看小说什么的，如果改成gentoo，乱玩的时候出点问题，那就上不了网，看不了小说鸟，所以决定双系统。
</p>

<h2 id="toc_1.2">安装流程如下</h2>
<ul>
<li>
先装win7,一个50G的c盘，加一个隐藏的100M小分区。<sup><small>这个小分区是被win7强制装的，用来作为启动分区，我猜应该是bios不能识别太过巨大的启动分区的缘故吧</small></sup>

<li>
100M对应/dev/sda1，50G对应/dev/sda2，都是主分区。

<li>
然后就装gentoo，分3个区，/boot(120M)-/dev/sda3主分区，/(20G)--/dev/sda5逻辑分区，swap(1.5G)--/dev/sda6逻辑分区。/dev/sda4是扩展分区，包含所有的磁盘剩余空间。

<li>
在win7中使用EasyBCD软件，添加一个gentoo的启动项，对应的启动分区当然是/dev/sda3这个/boot了。

<li>
在gentoo的安装最后一步“引导”的时候，需要将grub安装到/boot分区，这是后话。

<li>
最终的结果就是，开机选择win7 or gentoo，选择win7正常使用，选择gentoo，会出现gentoo中的grub产生的启动界面，当然也可以不产生，在grub.conf中配置时间为0就可以了。

<li>
最终的效果就是：gentoo不小心玩崩溃了也没关系，分区一格，重新安装，win7不受影响。

</ul>

<h2 id="toc_1.3">安装gentoo</h2>
<p>
<strong>win7的安装略去。</strong>
</p>

<p>
<strong>gentoo的安装过程如下：</strong>
</p>

<h3 id="toc_1.3.1">光盘启动</h3>
<p>
使用的是最小光盘+stage3的安装方式，最小光盘刻录成DVD，iso镜像刻录方式。
</p>
<ol>
<li>
默认gentoo内核

<li>
默认us键盘布局

</ol>

<h3 id="toc_1.3.2">配置无线网络</h3>
<p>
我的环境是无线网络，而且无线网络的加密模式是wpa，所以设置如下；除此之外，还有wep加密模式的无线网络，这个使用wireless-tools这个工具，iwconfig什么的；有线使用net-setup之类的。
</p>

<p>
最小光盘系统里已经安装了wpa_supplicant这个工具，这里可以直接使用，但在硬盘系统里在reboot之前一定要记得安装wpa_supplicant，否则就上不去网了。
</p>
<ol>
<li>
<code>ln -s /etc/init.d/net.lo /etc/init.d/net.wlan0</code>

<li>
<code>nano -w /etc/conf.d/net</code>

<ul>
<li>
<code>modules=("wpa_supplicant")</code>

<li>
<code>wpa_supplicant_wlan0="-Dwext"</code>

<li>
<code>config_wlan0=("dhcp")</code>

</ul>
<li>
<code>nano -w /etc/wpa_supplicant/wpa_supplicant.conf</code>

<ul>
<li>
<code>ctrl_interface=/var/run/wpa_supplicant</code>

<li>
<code>ctrl_interface_group=0</code>

<li>
<code>ap_scan=1</code>

<li>
<code>network={</code>

<li>
<code>	ssid="ustc"</code>

<li>
<code>	psk="password"</code>

<li>
<code>	priority=5</code>

<li>
<code>}</code>

</ul>
<li>
<code>/etc/init.d/net.wlan0 start</code>

</ol>

<h3 id="toc_1.3.3">分区-设置文件系统-挂载</h3>
<p>
硬盘分区使用fdisk工具，这里如前所述的分区；因为是尝试所以使用ext2和ext3,下次可以使用ext4的。
</p>
<ol>
<li>
<code>fdisk /dev/sda</code>

<li>
<code>mke2fs /dev/sda3</code>

<li>
<code>mke2fs -j /dev/sda5</code>

<li>
<code>mkswap /dev/sda6 &amp;&amp; swapon /dev/sda6</code>

<li>
<code>mount /dev/sda5 /mnt/gentoo</code>

<li>
<code>mkdir /mnt/gentoo/boot</code>

<li>
<code>mount /dev/sda3 /mnt/gentoo/boot</code>

</ol>

<h3 id="toc_1.3.4">观察PC时间</h3>
<p>
时间不对，自己改；我还没有遇见时间不对的情况。
</p>
<ol>
<li>
<code>date</code>

</ol>

<h3 id="toc_1.3.5">取得stage3和portage</h3>
<p>
也可以之前下载到U盘，然后从U盘（我这边显示是/dev/sdb，挂载到mnt下）copy到对应位置，学校的网速还是很NB的，所以直接下了。
</p>
<ol>
<li>
<code>cd /mnt/gentoo</code>

<li>
<code>links http://mirrors.ustc.edu.cn/gentoo</code>

<li>
<code>tar xvjpf stage3*.tar.gz</code>

<li>
<code>cd usr</code>

<li>
<code>links http://mirrors.ustc.edu.cn/gentoo</code>

<li>
<code>tar xvjf portage*.tar.gz</code>

</ol>

<h3 id="toc_1.3.6">配置/mnt/gentoo/etc/make.conf</h3>
<ol>
<li>
<code>CFLAGS="-02 -march=core2 -pipe"</code>

<li>
<code>CXXFLAGS="${CFLAGS}"</code>

<li>
<code>CHOST="i686-pc-linux-gnu"</code>

<li>
<code>MAKEOPTS="-j3"</code>

<li>
<code>SYNC="rsync://mirrors.ustc.edu.cn/gentoo-portage"</code>

<li>
<code>GENTOO_MIRRORS="http://mirrors.ustc.edu.cn/gentoo"</code>

</ol>

<h3 id="toc_1.3.7">切换到硬盘系统</h3>
<ol>
<li>
<code>copy /etc/resolv.conf /mnt/gentoo/etc</code>

<li>
<code>mount -t proc none /mnt/gentoo/proc</code>

<li>
<code>mount --rbind /dev /mnt/gentoo/dev</code>

<li>
<code>chroot /mnt/gentoo /bin/bash</code>

<li>
<code>env-update &amp;&amp; source /etc/profile</code>

</ol>

<h3 id="toc_1.3.8">更新portage tree</h3>
<ol>
<li>
<code>emerge --sync</code>

</ol>

<h3 id="toc_1.3.9">时区</h3>
<ol>
<li>
<code>cp /usr/share/zoneinfo/GMT /etc/localtime</code>

</ol>

<h3 id="toc_1.3.10">内核配置</h3>
<ol>
<li>
<code>emerge gentoo-sources</code>

<li>
<code>make menuconfig</code>  <sup><small>内核的配置以后有时间再述</small></sup>

<ul>
<li>
ext2支持

<li>
processor-core2

<li>
wireless支持

</ul>
<li>
<code>make &amp;&amp; make modules_install</code>

<li>
<code>cp /arch/i386/boot/bzImage /boot/kernel-2.6.36-r8</code>

</ol>

<h3 id="toc_1.3.11">一些必要的准备和安装</h3>
<ol>
<li>
<code>emerge net-wireless/iwl5000-ucode</code>  <sup><small>网卡必须的，我的网卡是intel 5100</small></sup>

<li>
<code>emerge wpa_supplicant</code>

<li>
<code>emerge wireless_tools</code>

<li>
<code>emerge dhcpcd</code>

<li>
<code>nano -w /etc/conf.d/net</code>  <sup><small>同上面的设置</small></sup>

<li>
<code>nano -w /etc/wpa_supplicant/wpa_supplicant.conf</code> <sup><small>同上面的设置</small></sup>

<li>
<code>ln -s /et/init.d/net.lo /etc/init.d/net.wlan0</code>

<li>
<code>rc-update add net.wlan0 default</code>

<li>
<code>find /lib/modules/&lt;&gt;/ -type f -iname '*.o' -or -iname '*.ko' &gt;&gt; /etc/module../kernel-2.6</code>

<li>
<code>nano -w /etc/module../kernel-2.6</code>  <sup><small>只留下模块的名字，比如xt_mark.o，就写成xt_mark</small></sup>

<li>
<code>nano -w /etc/fstab</code>

<li>
<code>passwd</code>

<li>
<code>nano -w /etc/conf.d/clock</code>

</ol>

<h3 id="toc_1.3.12">安装grub</h3>
<ol>
<li>
<code>emerge grub</code>

<li>
<code>nano -w /boot/grub/grub.conf</code>

<ul>
<li>
<code>default 0</code>

<li>
<code>timeout 30</code>

<li>
<code>title Gentoo Linux 2.6.36-r8</code>

<li>
<code>root (hd0,2)</code>   <sup><small>这里是/boot目录所在的地方</small></sup>

<li>
<code>kernel /boot/kernel-2.6.36-r8 root=/dev/sda5</code>  <sup><small>这里注意root是/目录在的地方</small></sup>

</ul>
<li>
<code>grep -v rootfs /proc/mounts&gt;/etc/mtab</code>

<li>
<code>grub-install --no-floppy /dev/sda3</code> <sup><small>这里是/boot目录</small></sup>

</ol>

<h3 id="toc_1.3.13">回到光盘系统-重启</h3>
<ol>
<li>
<code>exit</code>

<li>
<code>umount /mnt/gentoo/boot /mnt/gentoo/dev /mnt/gentoo/proc /mnt/gentoo</code>  <sup><small>有时候会出现无法umount，就直接reboot了，也没出上面问题</small></sup>

<li>
<code>reboot</code>

</ol>


<h2 id="toc_1.4">OVER</h2>

    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_title="双系统--WIN7和GENTOO";
        var disqus_shortname = 'xrfindvimwiki'; // required: replace example with your forum shortname
        var disqus_identifier="双系统--WIN7和GENTOO";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <div id="hbottom">
        <strong id="Times">Time is getting Fewer and Fewer.</strong>
        <a href="../../index.html">HomePage</a>
        <a id="Contents" href="#">Contents</a>
    </div>
</body>
</html>
