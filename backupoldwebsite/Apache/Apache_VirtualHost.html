<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Apache_VirtualHost</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="xrfind">
    <meta name="copyright" content="copyright (c) 三月 08, 2011 xrfind">
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link type="image/x-icon" rel="shortcut icon" href="../css/favicon.ico"/>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/moment.min.js"></script>
    <script type="text/javascript" src="../js/custom.js"> </script> 
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-36694423-1']);
        _gaq.push(['_setDomainName', 'rrrui.com']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script> 
</head>
<body>
    <div id="htop" style="width:128px;height:128px">
    </div>
    <div id="content">
        
<h1 id="toc_1">Apache2 VirtualHost</h1>

<h2 id="toc_1.1">About NameVirtualHost Directive</h2>
<p>
这个<code>NameVirtualHost</code>指令是和<code>&lt;VirtualHost&gt;</code>指令紧密联系的。两者的参数必须一样。
</p>
<ul>
<li>
<code>NameVirtualHost 1.2.3.4:80</code>

<li>
<code>&lt;VirtualHost 1.2.3.4:80&gt;</code>

<li>
<code>...</code>

<li>
<code>&lt;/VirtualHost&gt;</code>

</ul>

<p>
这个<code>NameVirtualHost</code>是在 <strong>name-based virtual hosts</strong> 时候必须的。从他的名字也可以看出，是用于name-based的。
</p>

<p>
也就是说，在配置 <strong>ip-based virtual hosts</strong> 的时候，<code>NameVirtualHost</code>是不需要，也用不上的。
</p>

<p>
但又有一点疑问：既然<code>NameVirtualHost</code>是用于name-based的，那么为什么其后的参数是ip+port呢？
</p>
<ul>
<li>
这是对 <strong>name-based virtual hosts</strong> 的一种限制，使用了<code>NameVirtualHost</code>的NBVH只能处理从该ip+port过来的指向NBVH中<code>ServerName</code>域名的请求。

<li>
而且，使用<code>NameVirtualHost</code>之后，所有指向<code>NameVirtualHost</code>的IP的请求都只能被NBVH处理，而不会被default server处理。

</ul>

<h2 id="toc_1.2">IP-based Virtual Host Support</h2>
<p>
理解这节，首先在脑海中形成一个画面：一条PC，有20个PCI/PCI-E插槽，每个上面连了一个网卡，每个网卡都接入了Internet，这台PC有20个独立静态IP。
</p>

<p>
在Apache中，基于一个IP但不同port的的VirtualHost也是IBVH。
</p>

<p>
<code>&lt;VirtualHost&gt;</code>中的参数推荐使用IP，而不是hostname，这说明这个里面是可以放hostname的。
</p>
<ul>
<li>
参数中确定IP和Port的VirtualHost，比参数中是wildcard类型的VirtualHost有更高的优先级，也就是说确定IP+Port和wildcard都符合的情况下，确定IP+Port的VirtualHost会处理请求。

<li>
任何VirtualHost都比server base configuration有更高的优先级。

</ul>

<p>
<strong>很好奇：如何区分一个VirtualHost是IP-based还是Name-based？</strong>
</p>

<h2 id="toc_1.3">Name-based Virtual Host Support</h2>
<p>
NBVH是建立在client将hostname作为HTTP header的一部份发送到server这一基础之上。
</p>

<p>
可以肯定，现在主流的浏览器应该都是这么做的。
</p>

<p>
区分一个VirtualHost是IP-based还是Name-based的方法就是看有没有使用<code>NameVirtualHost</code>？
</p>

<p>
<code>NameVirtualHost</code>指定的IP和Port，都必须是server上的可以的network interface。
</p>

<p>
NBVH的几个基本组成和规则，任何NBVH都必须如此才能称为NBVH。
</p>
<ul>
<li>
<code>NameVirtualHost</code>，有这个，才是NBVH。

<li>
必定有一个<code>&lt;VirtualHost&gt;</code>和上面的目录对应，也就是参数一致。

<li>
在<code>&lt;VirtualHost&gt;</code>之下，至少有一个<code>ServerName</code>和<code>DocumentRoot</code>。

<li>
这里的<code>ServerName</code>就是用来决定那个NBVH来服务。

</ul>

<p>
这里有点需要思考的东西：
一个<code>NameVirtualHost *</code>，可以对应N个<code>&lt;VirtualHost *&gt;</code>，然后通过各个VirtualHost下面的<code>ServerName</code>来判断那个NBVH来服务。
对于一个<code>NameVirtualHost 1.2.3.4:80</code>，那么也可以有N个<code>&lt;VirtualHost 1.2.3.4:90&gt;</code>吗？理论上可以有的，因为<code>ServerName</code>不同，所以可以分辨。
</p>

<p>
IBVH和NBVH可以共存，没啥问题。
</p>

<p>
VirtualHost里面的directive会覆盖其之外的主设置。
</p>

<p>
当request到达的时候，apache先是检查IP，寻找对应的<code>NameVirtualHost</code>，然后匹配hostname，然后没有找到的话，就使用第一个VirtualHost。（貌似即使不符合第一个的IP，也是第一个处理）。
</p>

<p>
IBVH更像是本来VirtualHost的样子，没有任何特殊的。
</p>

<p>
<code>NameVirtualHost</code>和<code>&lt;VirtualHost&gt;</code>的参数只应该是ip和port的组合，而不应该是hostname，应该如此的。
</p>

<p>
<strong>NBVH的本质是在IBVH确定之后进行的再深入区分，其实现是建立在IBVH的基础之上，没有IBVH就没有NBVH。</strong>
</p>
<h2 id="toc_1.4">An In-Depth Discussion of Virtual Host Matching</h2>

    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_title="Apache_VirtualHost";
        var disqus_shortname = 'xrfindvimwiki'; // required: replace example with your forum shortname
        var disqus_identifier="Apache_VirtualHost";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <div id="hbottom">
        <strong id="Times">Time is getting Fewer and Fewer.</strong>
        <a href="../index.html">HomePage</a>
        <a id="Contents" href="#">Contents</a>
    </div>
</body>
</html>
